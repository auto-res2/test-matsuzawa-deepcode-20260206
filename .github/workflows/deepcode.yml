name: "[Test] DeepCode Code Generation"

on:
  workflow_dispatch:
    inputs:
      hypothesis_json:
        description: 'ResearchHypothesis as JSON string'
        required: true
        type: string
      design_json:
        description: 'ExperimentalDesign as JSON string'
        required: true
        type: string
      custom_prompt:
        description: 'Custom prompt for DeepCode (optional, if empty will auto-generate)'
        required: false
        type: string
      model_name:
        description: 'Model to use (e.g., claude-opus-4, claude-sonnet-4-5)'
        required: false
        default: 'claude-sonnet-4-5'
        type: string

permissions:
  id-token: write
  contents: write
  actions: write

env:
  RESULTS_DIR: ".research/deepcode-results"

jobs:
  test-deepcode:
    name: Test DeepCode Code Generation
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p "$RESULTS_DIR"

      - name: Validate and save input JSON
        run: |
          # Validate hypothesis JSON
          echo '${{ github.event.inputs.hypothesis_json }}' | jq . > "$RESULTS_DIR/hypothesis.json" || {
            echo "ERROR: Invalid hypothesis JSON"
            exit 1
          }
          echo "✓ Hypothesis JSON valid"

          # Validate design JSON
          echo '${{ github.event.inputs.design_json }}' | jq . > "$RESULTS_DIR/design.json" || {
            echo "ERROR: Invalid design JSON"
            exit 1
          }
          echo "✓ Design JSON valid"

      - name: Setup prompt
        run: |
          if [ -n '${{ github.event.inputs.custom_prompt }}' ]; then
            echo '${{ github.event.inputs.custom_prompt }}' > "$RESULTS_DIR/prompt.txt"
            echo "✓ Using custom prompt"
          else
            echo "⚠ No custom prompt provided"
            echo "DeepCode will use internal default or CLI defaults"
          fi

      - name: Install deepcode-hku
        run: |
          pip install --upgrade pip
          pip install deepcode-hku
          deepcode --version

      - name: Run DeepCode
        run: |
          PROMPT_FILE="${{ env.RESULTS_DIR }}/prompt.txt"
          OUTPUT_DIR="${{ env.RESULTS_DIR }}/generated"

          # If custom prompt was provided, use it; otherwise pass empty
          if [ -f "$PROMPT_FILE" ]; then
            deepcode \
              --model "${{ github.event.inputs.model_name }}" \
              --prompt-file "$PROMPT_FILE" \
              --output-dir "$OUTPUT_DIR"
          else
            echo "No prompt file provided, DeepCode will use defaults"
            deepcode \
              --model "${{ github.event.inputs.model_name }}" \
              --output-dir "$OUTPUT_DIR"
          fi

      - name: Check results
        if: always()
        run: |
          echo "=== Results ==="
          if [ -d "$RESULTS_DIR/generated" ]; then
            echo "✓ Generated code found:"
            find "$RESULTS_DIR/generated" -type f | head -20
          else
            echo "⚠ No generated directory"
          fi

          echo ""
          echo "=== Artifacts to download ==="
          ls -lah "$RESULTS_DIR/"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deepcode-test-results-${{ github.run_id }}
          path: ${{ env.RESULTS_DIR }}
          retention-days: 7
