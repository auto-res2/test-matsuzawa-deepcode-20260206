name: "[Test] DeepCode Code Generation"

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model to use (e.g., claude-opus-4, claude-sonnet-4-5)'
        required: false
        default: 'claude-sonnet-4-5'
        type: string

permissions:
  id-token: write
  contents: write
  actions: write

env:
  RESULTS_DIR: ".research/deepcode-results"
  INPUTS_DIR: ".github/workflows/inputs"

jobs:
  test-deepcode:
    name: Test DeepCode Code Generation
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p "$RESULTS_DIR"

      - name: Copy and validate input files
        run: |
          # Copy input files from repo
          cp "$INPUTS_DIR/hypothesis.json" "$RESULTS_DIR/" || {
            echo "ERROR: hypothesis.json not found in $INPUTS_DIR"
            exit 1
          }
          cp "$INPUTS_DIR/design.json" "$RESULTS_DIR/" || {
            echo "ERROR: design.json not found in $INPUTS_DIR"
            exit 1
          }
          cp "$INPUTS_DIR/prompt.txt" "$RESULTS_DIR/" || {
            echo "ERROR: prompt.txt not found in $INPUTS_DIR"
            exit 1
          }

          # Validate JSON files
          jq . "$RESULTS_DIR/hypothesis.json" > /dev/null || {
            echo "ERROR: Invalid hypothesis.json"
            exit 1
          }
          echo "✓ hypothesis.json valid"

          jq . "$RESULTS_DIR/design.json" > /dev/null || {
            echo "ERROR: Invalid design.json"
            exit 1
          }
          echo "✓ design.json valid"

          # Check prompt file
          [ -s "$RESULTS_DIR/prompt.txt" ] || {
            echo "ERROR: prompt.txt is empty"
            exit 1
          }
          echo "✓ prompt.txt valid ($(wc -l < "$RESULTS_DIR/prompt.txt") lines)"

      - name: Install deepcode-hku
        run: |
          pip install --upgrade pip
          pip install deepcode-hku
          deepcode --version

      - name: Run DeepCode
        run: |
          OUTPUT_DIR="${{ env.RESULTS_DIR }}/generated"
          PROMPT_FILE="${{ env.RESULTS_DIR }}/prompt.txt"

          deepcode \
            --model "${{ github.event.inputs.model_name }}" \
            --prompt-file "$PROMPT_FILE" \
            --output-dir "$OUTPUT_DIR"

      - name: Check results
        if: always()
        run: |
          echo "=== Results ==="
          if [ -d "$RESULTS_DIR/generated" ]; then
            echo "✓ Generated code found:"
            find "$RESULTS_DIR/generated" -type f | head -20
          else
            echo "⚠ No generated directory"
          fi

          echo ""
          echo "=== Files in results directory ==="
          ls -lah "$RESULTS_DIR/"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deepcode-test-results-${{ github.run_id }}
          path: ${{ env.RESULTS_DIR }}
          retention-days: 7
